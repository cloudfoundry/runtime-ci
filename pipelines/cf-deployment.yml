---
groups:
- name: cf-deployment
  jobs:
  - fresh-deploy
  - fresh-acquire-pool
  - lite-release-pool
  - upgrade-deploy
  - upgrade-acquire-pool
  - upgrade-release-pool
  - lite-deploy
  - lite-acquire-pool
  - experimental-deploy
  - lint-cf-deployment-manifest
  - branch-freshness
  - fresh-cats
  - fresh-enable-docker-and-tasks
  - fresh-delete-deployment
  - upgrade-set-feature-flags
  - upgrade-cats
  - upgrade-cats-windows2016
  - lite-cats
  - experimental-cats
  - experimental-set-feature-flags
  - experimental-smoke-tests
  - experimental-acquire-pool
  - experimental-release-pool
  - lite-enable-docker-and-tasks
  - unit-test-ops-files
  - unit-test-cats
  - unit-test-update-releases-coverage
  - bless-manifest
  - ship-it-major
  - ship-it-minor
  - ship-it-patch
  - release-notes-template
- name: ex
  jobs:
  - unit-test-ops-files
  - unit-test-cats
  - unit-test-update-releases-coverage
  - experimental-acquire-pool
  - experimental-cats
  - experimental-deploy
  - experimental-set-feature-flags
  - experimental-release-pool
  - experimental-release-pool-manual
  - experimental-smoke-tests
  - experimental-ops-files
  - bless-manifest
- name: fr
  jobs:
  - unit-test-ops-files
  - unit-test-cats
  - unit-test-update-releases-coverage
  - fresh-acquire-pool
  - fresh-cats
  - fresh-delete-deployment
  - fresh-deploy
  - fresh-enable-docker-and-tasks
  - fresh-release-pool-manual
  - bless-manifest
- name: up
  jobs:
  - unit-test-ops-files
  - unit-test-cats
  - unit-test-update-releases-coverage
  - upgrade-acquire-pool
  - upgrade-deploy
  - upgrade-set-feature-flags
  - upgrade-cats
  - upgrade-cats-windows2016
  - upgrade-release-pool-manual
  - upgrade-release-pool
  - bless-manifest
- name: li
  jobs:
  - unit-test-ops-files
  - unit-test-cats
  - unit-test-update-releases-coverage
  - lite-acquire-pool
  - lite-cats
  - lite-deploy
  - lite-enable-docker-and-tasks
  - lite-release-pool
  - lite-release-pool-manual
  - bless-manifest
- name: st
  jobs:
  - stable-acquire-pool
  - stable-deploy
  - stable-smoke-tests
  - stable-semihourly-pool-acquisition
  - stable-periodic-cats
  - stable-release-pool-manual
  - stable-update-cats-cfd-branch
  - cleanup-stable-periodic-cats

resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource
- name: bosh-deployment-v2
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

resources:
- name: gcp-windows2012-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-windows2012R2-go_agent

- name: gcp-windows2016-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-windows2016-go_agent

- name: fresh-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/fresh
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))

- name: upgrade-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/upgrade
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))

- name: lite-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/lite
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))

- name: experimental-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/experimental
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))

- name: stable-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/stable
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))

- name: bellatrix-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/bellatrix-env.git
    private_key: ((bellatrix_env_readwrite_deploy_key.private_key))
    paths:
    - bbl-state
    - ha-proxy-vars.yml
- name: bellatrix-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/bellatrix-env.git
    private_key: ((bellatrix_env_readwrite_deploy_key.private_key))
    paths:
    - integration_config.json
- name: luna-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: ((luna_env_readwrite_deploy_key.private_key))
    paths:
    - bbl-state
- name: luna-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: ((luna_env_readwrite_deploy_key.private_key))
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: luna-env-vars-files
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: ((luna_env_readwrite_deploy_key.private_key))
    paths:
    - deployment-name.yml
    - network-name.yml
    - syslog-vars.yml
    - bbs-key-label.yml
    - gcs-vars.yml
- name: trelawney-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/trelawney-env.git
    private_key: ((trelawney_env_readwrite_deploy_key.private_key))
    paths:
    - bbl-state
- name: trelawney-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/trelawney-env.git
    private_key: ((trelawney_env_readwrite_deploy_key.private_key))
    paths:
    - integration_config.json
    - rats_integration_config.json
    - wats2016_integration_config.json
- name: half-hourly
  type: time
  source:
    interval: 30m
- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: hermione-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: ((hermione_env_readwrite_deploy_key.private_key))
    paths:
    - bbl-state
- name: hermione-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: ((hermione_env_readwrite_deploy_key.private_key))
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: hermione-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: ((hermione_env_readwrite_deploy_key.private_key))
    paths:
    - deployment-vars.yml
    - datadog-deployment-vars.yml
    - rds-vars.yml
    - runtime-config.yml
    - confab-timeout-vars.yml
    - scale-windows-cells.yml
- name: hermione-env-turbulence-vars
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: ((hermione_env_readwrite_deploy_key.private_key))
    paths:
    - turbulence-deployment-vars.yml
- name: hermione-env-turbulence-manifest
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: ((hermione_env_readwrite_deploy_key.private_key))
    paths:
    - turbulence.yml
- name: cf-deployment-develop
  type: git
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: cf-deployment-release-candidate
  type: git
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: cf-deployment-all-branches
  type: git
  source:
    branch: develop
    uri: https://github.com/cloudfoundry/cf-deployment.git
- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-acceptance-tests.git
    private_key: ((cf_acceptance_tests_readwrite_deploy_key.private_key))
- name: cf-test-helpers
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/cf-test-helpers
- name: cf-deployment-master
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: snitch-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: ((snitch_env_readwrite_deploy_key.private_key))
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: snitch-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: ((snitch_env_readwrite_deploy_key.private_key))
    paths:
    - bbl-state
- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment.git

- name: cf-deployment-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cloudfoundry/cf-relint-ci-semver.git
    branch: master
    private_key: ((cf_relint_ci_semver_readwrite_deploy_key.private_key))
    git_user: "CF MEGA BOT <cf-mega@pivotal.io>"
    file: cf-deployment-version

- name: deliver-tracker-story
  type: tracker
  source:
    token: ((cf_relint_tracker_api_token))
    project_id: "1382120"
    tracker_url: https://www.pivotaltracker.com

jobs:
- name: branch-freshness
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: cf-deployment-all-branches
      trigger: true
    - get: runtime-ci
  - task: validate-branch-freshness
    file: runtime-ci/tasks/validate-branch-freshness/task.yml
    input_mapping:
      repo: cf-deployment-all-branches

- name: fresh-acquire-pool
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: fresh-pool
      params: {acquire: true}

- name: upgrade-acquire-pool
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: upgrade-pool
      params: {acquire: true}

- name: lite-acquire-pool
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: lite-pool
      params: {acquire: true}

- name: lint-cf-deployment-manifest
  serial: false
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: lint-manifest
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
      inputs:
      - name: cf-deployment-develop
      run:
        path: /bin/bash
        args:
        - -exc
        - |
          ruby -e "require 'yaml'; YAML.load_file('./cf-deployment-develop/cf-deployment.yml')"

- name: unit-test-ops-files
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: unit-test-ops-files
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      params:
        RUN_SEMANTIC: true
      run:
        dir: cf-deployment-develop
        path: scripts/test

- name: unit-test-cats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-acceptance-tests
    trigger: true
  - get: cf-test-helpers
    trigger: true
  - get: runtime-ci
  - task: run-cats-unit-tests
    file: runtime-ci/tasks/run-cats-unit-tests/task.yml
  - task: run-cf-test-helpers-unit-tests
    file: runtime-ci/tasks/run-cf-test-helpers-unit-tests/task.yml

- name: unit-test-update-releases-coverage
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
  - get: runtime-ci
  - task: unit-test-update-releases-coverage
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      - name: runtime-ci
      run:
        dir: runtime-ci
        path: scripts/tests/update-releases-coverage-test

- name: fresh-deploy
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: fresh-pool
    trigger: true
    passed: [ fresh-acquire-pool ]
  - aggregate:
    - get: cf-deployment-develop
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: luna-env-vars-files
    - get: luna-env-integration-configs
    - get: luna-env-director-state
  - task: guarantee-no-existing-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
    params:
      DEPLOYMENT_NAME: luna-cf
  - task: bosh-upload-stemcell-fresh
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    input_mapping:
      cf-deployment: cf-deployment-develop
      bbl-state: luna-env-director-state
    params:
      INFRASTRUCTURE: google
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/credhub-compatible/bosh-deploy/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
      cf-deployment: cf-deployment-develop
      ops-files: cf-deployment-develop
      vars-files: luna-env-vars-files
    params:
      SYSTEM_DOMAIN: luna.cf-app.com
      OPS_FILES: |
        operations/experimental/fast-deploy-with-downtime-and-danger.yml
        operations/use-compiled-releases.yml
        operations/rename-network.yml
        operations/rename-deployment.yml
        operations/set-bbs-active-key.yml
        operations/test/add-persistent-isolation-segment-diego-cell.yml
        operations/test/add-persistent-isolation-segment-router.yml
        operations/addons/enable-component-syslog.yml
        operations/use-gcs-blobstore.yml
        operations/use-gcs-blobstore-service-account.yml
        operations/scale-database-cluster.yml
      VARS_FILES: |
        deployment-name.yml
        network-name.yml
        bbs-key-label.yml
        syslog-vars.yml
        gcs-vars.yml
      REGENERATE_CREDENTIALS: true
  - task: run-bosh-cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/credhub-compatible/update-integration-configs/task.yml
    params:
      CATS_INTEGRATION_CONFIG_FILE: integration_config.json
    input_mapping:
      bbl-state: luna-env-director-state
      integration-configs: luna-env-integration-configs
    ensure:
      put: luna-env-integration-configs
      params:
        repository: updated-integration-configs
        rebase: true
  - task: ensure-gcloud-backend-service-healthy
    file: runtime-ci/tasks/ensure-gcloud-backend-service-healthy/task.yml
    input_mapping:
      google-creds-dir: luna-env-director-state
    params:
      GCP_PROJECT_ID: ((luna_gcp_project))
      GCP_BACKEND_SERVICE: ((luna_router_backend_service))
      GOOGLE_ACCOUNT_CREDS_PATH: google_account_creds.json
  - task: ensure-api-healthy
    file: runtime-ci/tasks/ensure-api-healthy/task.yml
    params:
      SYSTEM_DOMAIN: luna.cf-app.com

- name: upgrade-deploy
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: upgrade-pool
    trigger: true
    passed: [upgrade-acquire-pool]
  - aggregate:
    - get: cf-deployment-develop
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: trelawney-env-integration-configs
    - get: trelawney-env-director-state
    - get: gcp-windows2012-stemcell
    - get: gcp-windows2016-stemcell
  - task: bosh-upload-stemcell-upgrade
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    input_mapping:
      cf-deployment: cf-deployment-develop
      bbl-state: trelawney-env-director-state
    params:
      INFRASTRUCTURE: google
  - task: bosh-upload-windows2012-stemcell
    file: runtime-ci/tasks/bosh-upload-stemcell/task.yml
    input_mapping:
      stemcell: gcp-windows2012-stemcell
      bbl-state: trelawney-env-director-state
    params:
      STEMCELL_NAME: '*.tgz'
  - task: bosh-upload-windows2016-stemcell
    file: runtime-ci/tasks/bosh-upload-stemcell/task.yml
    input_mapping:
      stemcell: gcp-windows2016-stemcell
      bbl-state: trelawney-env-director-state
    params:
      STEMCELL_NAME: '*.tgz'
  - task: add-tcp-domain
    file: runtime-ci/tasks/add-tcp-domain/task.yml
    input_mapping:
      vars-store: trelawney-env-director-state
      bbl-state: trelawney-env-director-state
    params:
      SYSTEM_DOMAIN: trelawney.cf-app.com
      VARS_STORE_PATH: ""
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/credhub-compatible/bosh-deploy/task.yml
    input_mapping:
      bbl-state: trelawney-env-director-state
      cf-deployment: cf-deployment-develop
      ops-files: cf-deployment-develop
      vars-files: trelawney-env-director-state
    params:
      SYSTEM_DOMAIN: trelawney.cf-app.com
      OPS_FILES: |
        operations/windows-cell.yml
        operations/windows2016-cell.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      MEASURE_SYSLOG_AVAILABILITY: true
      FAIL_ON_DOWNTIME: true
      TCP_DOMAIN: tcp.trelawney.cf-app.com
      AVAILABLE_PORT: 1100
      HTTP_AVAILABILITY_THRESHOLD: 0
      APP_PUSHABILITY_THRESHOLD: 2
      RECENT_LOGS_THRESHOLD: 7
      STREAMING_LOGS_THRESHOLD: 2
      APP_SYSLOG_AVAILABILITY_THRESHOLD: 12
  - task: run-bosh-cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    input_mapping:
      bbl-state: trelawney-env-director-state
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/credhub-compatible/update-integration-configs/task.yml
    params:
      CATS_INTEGRATION_CONFIG_FILE: integration_config.json
    input_mapping:
      bbl-state: trelawney-env-director-state
      integration-configs: trelawney-env-integration-configs
    ensure:
      put: trelawney-env-integration-configs
      params:
        repository: updated-integration-configs
        rebase: true
  - task: ensure-api-healthy
    file: runtime-ci/tasks/ensure-api-healthy/task.yml
    params:
      SYSTEM_DOMAIN: trelawney.cf-app.com

- name: experimental-acquire-pool
  public: true
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: experimental-pool
      params: {acquire: true}

- name: experimental-release-pool
  public: true
  plan:
  - get: experimental-pool
    passed: [ experimental-cats, experimental-smoke-tests ]
    trigger: true
  - put: experimental-pool
    params: {release: experimental-pool}

- name: stable-acquire-pool
  public: true
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-master
      trigger: true
    - put: stable-pool
      params: {acquire: true}

- name: lite-release-pool
  public: true
  plan:
  - get: lite-pool
    passed: [ lite-cats ]
    trigger: true
  - put: lite-pool
    params: {release: lite-pool}

- name: fresh-release-pool-manual
  public: true
  plan:
  - get: fresh-pool
  ensure:
    try:
      put: fresh-pool
      params: {release: fresh-pool}

- name: upgrade-release-pool-manual
  public: true
  plan:
  - get: upgrade-pool
  ensure:
    try:
      put: upgrade-pool
      params: {release: upgrade-pool}

- name: upgrade-release-pool
  public: true
  plan:
  - get: upgrade-pool
    passed: [ upgrade-cats, upgrade-cats-windows2016 ]
    trigger: true
  - put: upgrade-pool
    params: {release: upgrade-pool}

- name: lite-release-pool-manual
  public: true
  plan:
  - get: lite-pool
  ensure:
    try:
      put: lite-pool
      params: {release: lite-pool}

- name: stable-release-pool-manual
  public: true
  plan:
  - get: stable-pool
  ensure:
    try:
      put: stable-pool
      params: {release: stable-pool}

- name: experimental-release-pool-manual
  public: true
  plan:
  - get: experimental-pool
  ensure:
    try:
      put: experimental-pool
      params: {release: experimental-pool}

- name: experimental-ops-files
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-acquire-pool ]
    - get: runtime-ci
  - task: experimental-ops-files
    file: runtime-ci/tasks/summarize-ops-files/task.yml

- name: experimental-deploy
  serial_groups: [ hermione-wats, hermione-cats, hermione-smokes ]
  public: true
  build_logs_to_retain: 100
  plan:
  - do:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
        passed: [ experimental-acquire-pool ]
      - get: hermione-env-vars-store
      - get: hermione-env-turbulence-manifest
      - get: hermione-env-turbulence-vars
      - get: hermione-env-director-state
      - get: hermione-env-integration-configs
    - task: bosh-upload-stemcell-experimental
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
        bbl-state: hermione-env-director-state
      params:
        INFRASTRUCTURE: aws
    - task: bosh-update-runtime-config
      file: runtime-ci/tasks/bosh-update-runtime-config/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
        runtime-configs: hermione-env-vars-store
        vars-files: hermione-env-vars-store
      params:
        RUNTIME_CONFIG_FILE: runtime-config.yml
    - task: deploy-turbulence-api-experimental
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        cf-deployment: hermione-env-turbulence-manifest
        vars-store: hermione-env-turbulence-vars
        bbl-state: hermione-env-director-state
        ops-files: runtime-ci
        vars-files: hermione-env-turbulence-vars
      params:
        MANIFEST_FILE: turbulence.yml
        SYSTEM_DOMAIN: cf-app.com # not used, this is a required by the task
        VARS_STORE_FILE: turbulence-deployment-vars.yml
        OPS_FILES: "experiments/operations/add-turbulence-bosh-io-release.yml experiments/operations/add-bosh-dns-bosh-io-release.yml"
      ensure:
        put: hermione-env-turbulence-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: add-tcp-domain
      file: runtime-ci/tasks/add-tcp-domain/task.yml
      input_mapping:
        vars-store: hermione-env-vars-store
        bbl-state: hermione-env-director-state
      params:
        SYSTEM_DOMAIN: hermione.cf-app.com
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
        cf-deployment: cf-deployment-develop
        ops-files: cf-deployment-develop
        vars-store: hermione-env-vars-store
        vars-files: hermione-env-vars-store
      params:
        SYSTEM_DOMAIN: hermione.cf-app.com
        OPS_FILES: |
          operations/aws.yml
          operations/test/add-datadog-firehose-nozzle.yml
          operations/use-compiled-releases.yml
          operations/use-s3-blobstore.yml
          operations/experimental/secure-service-credentials.yml
          operations/experimental/use-cf-networking-2.yml
          operations/experimental/enable-iptables-logger-with-networking-2.yml
          operations/experimental/use-bosh-dns.yml
          operations/experimental/use-bosh-dns-for-containers-with-networking-2.yml
          operations/experimental/perm-service.yml
          operations/scale-database-cluster.yml
          operations/experimental/use-pxc.yml
          operations/experimental/secure-service-credentials-with-pxc-release.yml
          operations/experimental/perm-service-with-pxc-release.yml
          operations/stop-skipping-tls-validation.yml
          operations/experimental/skip-consul-locks.yml
          operations/experimental/skip-consul-cell-registrations.yml
          operations/experimental/disable-consul.yml
          operations/experimental/enable-service-discovery.yml
          operations/experimental/enable-bpm.yml
          operations/experimental/use-log-cache.yml
          operations/experimental/enable-routing-integrity.yml
          operations/experimental/enable-prefer-declarative-healthchecks.yml
        VARS_FILES: "datadog-deployment-vars.yml"
        DEPLOY_WITH_UPTIME_MEASUREMENTS: true
        MEASURE_SYSLOG_AVAILABILITY: true
        TCP_DOMAIN: tcp.hermione.cf-app.com
        AVAILABLE_PORT: 1100
        APP_PUSHABILITY_THRESHOLD: 3
        HTTP_AVAILABILITY_THRESHOLD: 0
        RECENT_LOGS_THRESHOLD: 9
        STREAMING_LOGS_THRESHOLD: 2
        APP_SYSLOG_AVAILABILITY_THRESHOLD: 19
        FAIL_ON_DOWNTIME: true
      ensure:
        put: hermione-env-vars-store
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        vars-store: hermione-env-vars-store
        integration-configs: hermione-env-integration-configs
      ensure:
        put: hermione-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true
    - task: open-asgs-for-credhub
      file: runtime-ci/tasks/open-asgs-for-bosh-instance-group/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
        vars-store: hermione-env-vars-store
      params:
        INSTANCE_GROUP_NAME: credhub
        SYSTEM_DOMAIN: hermione.cf-app.com
        SECURITY_GROUP_NAME: credhub
    - task: open-asgs-for-uaa
      file: runtime-ci/tasks/open-asgs-for-bosh-instance-group/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
        vars-store: hermione-env-vars-store
      params:
        INSTANCE_GROUP_NAME: uaa
        SYSTEM_DOMAIN: hermione.cf-app.com
        SECURITY_GROUP_NAME: uaa

- name: stable-deploy
  serial_groups: [ bellatrix-smokes ]
  public: true
  build_logs_to_retain: 100
  plan:
  - on_success:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-master
      - get: bellatrix-env-director-state
      - get: bellatrix-env-integration-configs
      - get: gcp-windows2016-stemcell
    - task: bosh-upload-stemcell-stable
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-master
        bbl-state: bellatrix-env-director-state
      params:
        INFRASTRUCTURE: google
    - task: bosh-upload-windows2016-stemcell
      file: runtime-ci/tasks/bosh-upload-stemcell/task.yml
      input_mapping:
        stemcell: gcp-windows2016-stemcell
        bbl-state: bellatrix-env-director-state
      params:
        STEMCELL_NAME: '*.tgz'
    - task: add-tcp-domain
      file: runtime-ci/tasks/add-tcp-domain/task.yml
      input_mapping:
        vars-store: bellatrix-env-director-state
        bbl-state: bellatrix-env-director-state
      params:
        SYSTEM_DOMAIN: bellatrix.cf-app.com
        VARS_STORE_PATH: ""
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-master
        new-ops-files: bellatrix-env-director-state
      params:
        BASE_OPS_FILE_DIR: "operations"
        NEW_OPS_FILES: "use-4-azs-for-router.yml"
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/credhub-compatible/bosh-deploy/task.yml
      input_mapping:
        bbl-state: bellatrix-env-director-state
        cf-deployment: cf-deployment-master
        ops-files: collected-ops-files
        vars-files: bellatrix-env-director-state
      params:
        SYSTEM_DOMAIN: bellatrix.cf-app.com
        OPS_FILES: |
          operations/scale-database-cluster.yml
          operations/windows2016-cell.yml
          operations/use-4-azs-for-router.yml
          operations/use-haproxy.yml
          operations/use-haproxy-public-network.yml
        DEPLOY_WITH_UPTIME_MEASUREMENTS: true
        MEASURE_SYSLOG_AVAILABILITY: true
        TCP_DOMAIN: tcp.bellatrix.cf-app.com
        AVAILABLE_PORT: 1100
        HTTP_AVAILABILITY_THRESHOLD: 0
        APP_PUSHABILITY_THRESHOLD: 2
        RECENT_LOGS_THRESHOLD: 7
        STREAMING_LOGS_THRESHOLD: 2
        APP_SYSLOG_AVAILABILITY_THRESHOLD: 0
        VARS_FILES: ha-proxy-vars.yml
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: bellatrix-env-director-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/credhub-compatible/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        bbl-state: bellatrix-env-director-state
        integration-configs: bellatrix-env-integration-configs
      ensure:
        put: bellatrix-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true

- name: lite-deploy
  public: true
  serial_groups: [ snitch-cats ]
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
      - get: bosh-deployment
      - get: snitch-env-director-state
      - get: snitch-env-integration-configs
    - task: guarantee-no-existing-cf-deployment
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
    - task: bosh-upload-stemcell-lite
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
        bbl-state: snitch-env-director-state
      params:
        INFRASTRUCTURE: bosh-lite
    - task: bosh-deploy-cf-deployment
      file: cf-deployment-concourse-tasks/credhub-compatible/bosh-deploy/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
        cf-deployment: cf-deployment-develop
        ops-files: cf-deployment-develop
        vars-files: snitch-env-director-state
      params:
        SYSTEM_DOMAIN: snitch.cf-app.com
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/experimental/fast-deploy-with-downtime-and-danger.yml
          operations/bosh-lite.yml
          operations/use-postgres.yml
          operations/experimental/enable-tls-cloud-controller-postgres.yml
        REGENERATE_CREDENTIALS: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/credhub-compatible/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        bbl-state: snitch-env-director-state
        integration-configs: snitch-env-integration-configs
      ensure:
        put: snitch-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true

- name: experimental-cats
  serial_groups: [ hermione-cats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-set-feature-flags ]
    - aggregate:
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
      - get: hermione-env-integration-configs
      - get: hermione-env-vars-store
        passed: [ experimental-set-feature-flags ]
      - get: cf-deployment-develop
        passed: [ experimental-set-feature-flags ]
      - get: cf-deployment-concourse-tasks
    - task: run-cats
      input_mapping:
        integration-config: hermione-env-integration-configs
      file: cf-deployment-concourse-tasks/run-cats/task.yml

- name: experimental-smoke-tests
  serial_groups: [hermione-smokes]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 1h
    do:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-set-feature-flags ]
    - aggregate:
      - get: hermione-env-director-state
      - get: cf-deployment-develop
        passed: [ experimental-set-feature-flags ]
      - get: cf-deployment-concourse-tasks
  - task: bosh-run-errand-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: hermione-env-director-state
    params:
      ERRAND_NAME: smoke-tests

- name: stable-smoke-tests
  serial_groups: [bellatrix-smokes]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 1h
    do:
    - get: stable-pool
      trigger: true
      passed: [stable-deploy]
    - aggregate:
      - get: bellatrix-env-director-state
        passed: [stable-deploy]
      - get: cf-deployment-master
        passed: [stable-deploy]
      - get: cf-deployment-concourse-tasks
  - task: bosh-run-errand-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: bellatrix-env-director-state
    params:
      ERRAND_NAME: smoke-tests
    on_failure:
      put: stable-pool
      params: {release: stable-pool}

- name: stable-semihourly-pool-acquisition
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: half-hourly
      trigger: true
    - put: stable-pool
      params: {claim: bellatrix}

- name: stable-periodic-cats
  serial: true
  public: true
  build_logs_to_retain: 2000
  plan:
  - timeout: 4h
    on_failure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-semihourly-pool-acquisition ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
      - get: bellatrix-env-integration-configs
      - get: bellatrix-env-director-state
      - get: cf-deployment-master
        passed: [ stable-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/credhub-compatible/set-feature-flags/task.yml
      input_mapping:
        bbl-state: bellatrix-env-director-state
      params:
        SYSTEM_DOMAIN: bellatrix.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation
          service_instance_sharing
    - task: run-cats
      input_mapping:
        integration-config: bellatrix-env-integration-configs
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      params:
        FLAKE_ATTEMPTS: 0

- name: cleanup-stable-periodic-cats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-periodic-cats ]
    - aggregate:
      - get: runtime-ci
      - get: bellatrix-env-integration-configs
    - task: cleanup-stable-periodic-cats
      file: runtime-ci/tasks/cleanup-after-cats/task.yml
      input_mapping:
        integration-config: bellatrix-env-integration-configs

- name: stable-update-cats-cfd-branch
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    ensure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-periodic-cats ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-master
        passed: [ stable-periodic-cats ]
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
        passed: [ stable-periodic-cats ]
    - task: update-branch
      file: runtime-ci/tasks/update-cats-branch-with-cf-deployment-version/task.yml
      input_mapping:
        cf-deployment: cf-deployment-master
      params:
        DEPLOY_KEY: ((cf_acceptance_tests_readwrite_deploy_key.private_key))

- name: fresh-enable-docker-and-tasks
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed: [ fresh-deploy ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: luna-env-director-state
      - get: cf-deployment-develop
        passed: [ fresh-deploy ]
    - task: enable-docker-and-tasks
      attempts: 2
      file: cf-deployment-concourse-tasks/credhub-compatible/set-feature-flags/task.yml
      input_mapping:
        bbl-state: luna-env-director-state
      params:
        SYSTEM_DOMAIN: luna.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation

- name: upgrade-set-feature-flags
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-deploy]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
        passed: [upgrade-deploy]
      - get: trelawney-env-director-state
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/credhub-compatible/set-feature-flags/task.yml
      input_mapping:
        bbl-state: trelawney-env-director-state
      params:
        SYSTEM_DOMAIN: trelawney.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation
          service_instance_sharing

- name: lite-enable-docker-and-tasks
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-deploy ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: snitch-env-director-state
      - get: cf-deployment-develop
        passed: [ lite-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/credhub-compatible/set-feature-flags/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
      params:
        SYSTEM_DOMAIN: snitch.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation

- name: experimental-set-feature-flags
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-deploy ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: hermione-env-vars-store
      - get: cf-deployment-develop
        passed: [ experimental-deploy ]
    - task: set-feature-flags
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: hermione-env-vars-store
      params:
        SYSTEM_DOMAIN: hermione.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation
          service_instance_sharing

- name: fresh-cats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed: [ fresh-enable-docker-and-tasks ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
      - get: luna-env-integration-configs
      - get: cf-deployment-develop
        passed: [ fresh-enable-docker-and-tasks ]
    - task: run-cats
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      input_mapping:
        integration-config: luna-env-integration-configs
      params:
        CAPTURE_LOGS: true

- name: upgrade-cats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-set-feature-flags]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
      - get: trelawney-env-integration-configs
      - get: cf-deployment-develop
        passed: [upgrade-set-feature-flags]
    - task: run-cats
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      input_mapping:
        integration-config: trelawney-env-integration-configs
      params:
        CAPTURE_LOGS: true

- name: upgrade-cats-windows2016
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-set-feature-flags]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
      - get: trelawney-env-integration-configs
      - get: cf-deployment-develop
        passed: [upgrade-set-feature-flags]
    - task: run-cats
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      input_mapping:
        integration-config: trelawney-env-integration-configs
      params:
        CAPTURE_LOGS: true
        CONFIG_FILE_PATH: cats_windows2016_integration_config.json
        NODES: 8

- name: lite-cats
  serial_groups: [ snitch-cats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-enable-docker-and-tasks ]
    - aggregate:
      - get: cf-acceptance-tests
        passed: [ unit-test-cats ]
      - get: cf-deployment-develop
        passed: [ lite-enable-docker-and-tasks ]
      - get: snitch-env-integration-configs
      - get: cf-deployment-concourse-tasks
    - task: run-cats
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      input_mapping:
        integration-config: snitch-env-integration-configs
      params:
        NODES: 4

- name: fresh-delete-deployment
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed:
      - fresh-cats
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: luna-env-director-state
    - task: delete-deployment-cf
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
      input_mapping:
        bbl-state: luna-env-director-state
      params:
        DEPLOYMENT_NAME: luna-cf
    - put: fresh-pool
      params: {release: fresh-pool}

- name: bless-manifest
  public: true
  serial: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
    passed:
    - fresh-cats
    - lite-cats
    - upgrade-cats
    - upgrade-cats-windows2016
    - experimental-cats
    - experimental-smoke-tests
  - put: cf-deployment-release-candidate
    params:
      repository: cf-deployment-develop
  - put: deliver-tracker-story
    params:
      repos:
        - cf-deployment-develop

- name: release-notes-template
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: cf-deployment-master
    - get: cf-deployment-release-candidate
      passed:
      - bless-manifest
      trigger: true
  - task: generate-cf-deployment-release-notes-template
    file: runtime-ci/tasks/cf-deployment-release-notes-template/task.yml

- name: ship-it-patch
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - get: cf-deployment-version
        params: {bump: patch}
      - get: cf-deployment-develop
      - get: cf-deployment-release-candidate
        passed: [bless-manifest]
      - task: update-cf-deployment-manifest-version
        file: runtime-ci/tasks/record-cfd-version-in-manifest/task.yml
      - put: cf-deployment-master
        params:
          repository: cf-deployment-rc-with-updated-version
          tag: cf-deployment-version/version
          tag_prefix: v
      - put: cf-deployment-develop
        params:
          repository: cf-deployment-rc-with-updated-version
          merge: true
      - put: cf-deployment-version
        params: {bump: patch}

- name: ship-it-minor
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - get: cf-deployment-version
        params: {bump: minor}
      - get: cf-deployment-develop
      - get: cf-deployment-release-candidate
        passed: [bless-manifest]
      - task: update-cf-deployment-manifest-version
        file: runtime-ci/tasks/record-cfd-version-in-manifest/task.yml
      - put: cf-deployment-master
        params:
          repository: cf-deployment-rc-with-updated-version
          tag: cf-deployment-version/version
          tag_prefix: v
      - put: cf-deployment-develop
        params:
          repository: cf-deployment-rc-with-updated-version
          merge: true
      - put: cf-deployment-version
        params: {bump: minor}

- name: ship-it-major
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - get: cf-deployment-version
        params: {bump: major}
      - get: cf-deployment-develop
      - get: cf-deployment-release-candidate
        passed: [bless-manifest]
      - task: update-cf-deployment-manifest-version
        file: runtime-ci/tasks/record-cfd-version-in-manifest/task.yml
      - put: cf-deployment-master
        params:
          repository: cf-deployment-rc-with-updated-version
          tag: cf-deployment-version/version
          tag_prefix: v
      - put: cf-deployment-develop
        params:
          repository: cf-deployment-rc-with-updated-version
          merge: true
      - put: cf-deployment-version
        params: {bump: major}
